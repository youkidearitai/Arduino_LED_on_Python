<html>
<head>
    <meta charset = "utf-8">
    <title>加速度センサー</title>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
</head>

<body>
<div id="d3graph" style="border:1px solid #FFF; margin-bottom:10px"></div>
<div id="angle"></div>
</body>
<script type="text/javascript">
window.onload = function() {
    var stage;
    var socket = new WebSocket('ws://127.0.0.1:8080/graph', ['soap', 'chat']);
    stage = d3.select("#d3graph").append("svg:svg").attr("width", 800).attr("height", 600);

    var colors = d3.scale.category10();
    var d3Line = d3.svg.line()
    .x(function(d,i){return i * 10})
    .y(function(d,i){return (800 - d) / 1024 * 600});

    var points = {
        x: new Array(),
        y: new Array(),
        z: new Array()
    };

    // http://bl.ocks.org/aaizemberg/78bd3dade9593896a59d
    var point_colors = {
        x: 1,
        y: 2,
        z: 3
    };

    socket.onmessage = function(e) {
        var values = JSON.parse(e.data);
        update(values[1], 'x');
        update(values[2], 'y');
        update(values[3], 'z');
        stage.selectAll(".fourtext").remove();

        textUpdate(values[4], 30, 30);

        textUpdate(Math.atan2(values[5] - (1.65 / (5 / 1024)), values[6] - (2.31 / (5 / 1024))) / Math.PI * 180 + 180, 200, 30);
        textUpdate(values[5], 30, 50);
        textUpdate(Math.atan2(values[4] - (1.65 / (5 / 1024)), values[6] - (2.31 / (5 / 1024))) / Math.PI * 180 + 180, 200, 50);
        textUpdate(values[6], 30, 70);
    };

    function textUpdate(value, x, y) {
        stage.append("text").attr("class", "fourtext").attr("x", x).attr("y", y).text(value);
    }

    function update(value, key) {
        points[key].push(value);

        if(points[key].length > 800/10) {
            points[key].shift();
        }

        // 削除する
        stage.selectAll("." + key).remove();

        // 描画する
        stage.append("path")
        .attr("d", d3Line(points[key]))
        .attr("stroke", colors(point_colors[key]))
        .attr("fill", "none")
        .attr("class", key)
        .attr("opacity", 3);
    }
};
</script>
</html>
